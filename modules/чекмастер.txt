//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеПечатиЧекаРеальное(РезультатПечатиЧекаНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("ЗавершениеПечатиЧека с реузльатом" + СокрЛП(РезультатПечатиЧекаНаККТ));
	ОписаниеОшибки = "";
	резЗакрытияФормыПредваритПросмЧека = ИСТИНА;
	Если РезультатПечатиЧекаНаККТ = НЕОПРЕДЕЛЕНО тогда
		ОписаниеОшибки = "Печать чека отменена пользователем";
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
	иначеЕсли Не РезультатПечатиЧекаНаККТ.Результат тогда
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
		ОписаниеОшибки = РезультатПечатиЧекаНаККТ.ОписаниеОшибки;
	конецЕсли;
						
	ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
	Если резЗакрытияФормыПредваритПросмЧека Или ИспользоватьБезПодключенияОборудования Тогда
		
		// Установить полученное значение номера чека реквизиту документа.
		Если Не ИспользоватьБезПодключенияОборудования Тогда
			Объект.НомерЧекаККМ = РезультатПечатиЧекаНаККТ.НомерЧека;
		КонецЕсли;
				
		Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЧековККМ.Пробит");
		Объект.Дата   = ТекущаяДата();
		Если Не ЗначениеЗаполнено(Объект.НомерЧекаККМ) Тогда
			Объект.НомерЧекаККМ = 1;
		КонецЕсли;			
		Модифицированность = Истина;					
		РезультатПроведения = Записать(Новый Структура("РежимЗаписи, РежимПроведения", РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Оперативный));					
		Если РезультатПроведения = Истина Тогда
			ЧекПробит = Истина;
		КонецЕсли;					
		ПересчитатьДокументНаКлиенте();
		ПодключитьОбработчикОжидания("УстановитьТекущийЭлементНаКнопкуЗакрыть", 0.1, Истина);		
		Если ЧекПробит Тогда
			ТолькоПросмотр = Истина;
		КонецЕсли;		
	Иначе
		ТекстСообщения = НСтр("ru = 'При печати чека произошла ошибка.
		|Чек не напечатан на фискальном регистраторе.
		|Дополнительное описание:
		|%ДополнительноеОписание%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
		"%ДополнительноеОписание%",
				
		ОписаниеОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);				
	КонецЕсли;
конецПроцедуры //ЗавершениеПечатиЧека

&НаКлиенте
Функция ПробитьЧекВыполнить()
	
	ЧекПробит = Ложь;
	
	ОписаниеОшибки = "";
	
	Если Объект.НомерЧекаККМ <> 0 Тогда
		
		ТекстСообщения = НСтр("ru = 'Чек уже пробит на фискальном регистраторе!'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
		
	КонецЕсли;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда // Проверка на определенность рабочего места ВО
	
		ИдентификаторУстройстваФР              = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ЗначениеЗаполнено(ИдентификаторУстройстваФР) Или ИспользоватьБезПодключенияОборудования Тогда
			
			//Сообщить("Вставка кода для печти");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеПечатиЧекаРеальное", ЭтотОбъект);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ПечатьЧека", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма, Объект.Ссылка)
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат ЛОЖЬ; //
			конецЕсли;
