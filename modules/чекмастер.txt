//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеПечатиЧекаРеальное(РезультатПечатиЧекаНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("ЗавершениеПечатиЧека с реузльатом" + СокрЛП(РезультатПечатиЧекаНаККТ));
	ОписаниеОшибки = "";
	резЗакрытияФормыПредваритПросмЧека = ИСТИНА;
	Если РезультатПечатиЧекаНаККТ = НЕОПРЕДЕЛЕНО тогда
		ОписаниеОшибки = "Печать чека отменена пользователем";
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
	иначеЕсли Не РезультатПечатиЧекаНаККТ.Результат тогда
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
		ОписаниеОшибки = РезультатПечатиЧекаНаККТ.ОписаниеОшибки;
	конецЕсли;
						
	ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
	Если резЗакрытияФормыПредваритПросмЧека Или ИспользоватьБезПодключенияОборудования Тогда
		
		// Установить полученное значение номера чека реквизиту документа.
		Если Не ИспользоватьБезПодключенияОборудования Тогда
			Объект.НомерЧекаККМ = РезультатПечатиЧекаНаККТ.НомерЧека;
		КонецЕсли;
				
		Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЧековККМ.Пробит");
		Объект.Дата   = ТекущаяДата();
		Если Не ЗначениеЗаполнено(Объект.НомерЧекаККМ) Тогда
			Объект.НомерЧекаККМ = 1;
		КонецЕсли;			
		Модифицированность = Истина;					
		РезультатПроведения = Записать(Новый Структура("РежимЗаписи, РежимПроведения", РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Оперативный));					
		Если РезультатПроведения = Истина Тогда
			ЧекПробит = Истина;
		КонецЕсли;					
		ПересчитатьДокументНаКлиенте();
		ПодключитьОбработчикОжидания("УстановитьТекущийЭлементНаКнопкуЗакрыть", 0.1, Истина);		
		Если ЧекПробит Тогда
			ТолькоПросмотр = Истина;
		КонецЕсли;		
	Иначе
		ТекстСообщения = НСтр("ru = 'При печати чека произошла ошибка.
		|Чек не напечатан на фискальном регистраторе.
		|Дополнительное описание:
		|%ДополнительноеОписание%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
		"%ДополнительноеОписание%",
				
		ОписаниеОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);				
	КонецЕсли;
конецПроцедуры //ЗавершениеПечатиЧека

&НаКлиенте
Функция ПробитьЧекВыполнить()
	
	ЧекПробит = Ложь;
	
	ОписаниеОшибки = "";
	
	Если Объект.НомерЧекаККМ <> 0 Тогда
		
		ТекстСообщения = НСтр("ru = 'Чек уже пробит на фискальном регистраторе!'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
		
	КонецЕсли;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда // Проверка на определенность рабочего места ВО
	
		ИдентификаторУстройстваФР              = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ЗначениеЗаполнено(ИдентификаторУстройстваФР) Или ИспользоватьБезПодключенияОборудования Тогда
			
			//Сообщить("Вставка кода для печти");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеПечатиЧекаРеальное", ЭтотОбъект);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ПечатьЧека", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма, Объект.Ссылка, СокрЛП(ТекущийПродавец))
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат ЛОЖЬ; //
			конецЕсли;

****************************************************

//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеОтркытиеСменыРеальное(РезультатОтркытиеСменыНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("РезультатОтркытиеСменыНаККТ с реузльатом" + СокрЛП(РезультатОтркытиеСменыНаККТ));
	Если РезультатОтркытиеСменыНаККТ = НЕОПРЕДЕЛЕНО тогда
		Сообщить("При открытии смены на фискальном регистраторе произошла ошибка");
		Возврат;
	конецЕсли;	
	Если Не РезультатОтркытиеСменыНаККТ.Результат 
		И Не ДопПараметры.ИспользоватьБезПодключенияОборудования Тогда		
		ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
		                      |Смена не открыта на фискальном регистраторе.
		                      |Дополнительное описание:
		                      |%ДополнительноеОписание%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
		                       "%ДополнительноеОписание%",
		                         РезультатОтркытиеСменыНаККТ.ОписаниеОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);		
	Иначе			
		Результат = ОткрытьКассовуюСменуНаСервереБезКонтекста(Объект.КассаККМ, ОписаниеОшибки);		
		Если Не Результат Тогда						
			ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
			                            |Смена не открыта.
			                            |Дополнительное описание:
			                            |%ДополнительноеОписание%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ДополнительноеОписание%", ОписаниеОшибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
						
		КонецЕсли;
	КонецЕсли;			
	
	ОбновитьСостояниеКассовойСменыНаСервере();	
	ПересчитатьДокументНаКлиенте();	
конецПроцедуры //ЗавершениеОтркытиеСменыРеальное

&НаКлиенте
Процедура ОткрытьКассовуюСмену(Команда)
	
	ОчиститьСообщения();
	
	Результат = Ложь;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда
		
		// Подключение устройства
		ИдентификаторУстройства                = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ИдентификаторУстройства <> Неопределено Или ИспользоватьБезПодключенияОборудования Тогда
			
			ОписаниеОшибки = "";
			
			//Сообщить("Вставка кода для открытия смены");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее = Новый Структура;
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИдентификаторУстройства", ИдентификаторУстройства);
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИспользоватьБезПодключенияОборудования", ИспользоватьБезПодключенияОборудования);
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеОтркытиеСменыРеальное", ЭтотОбъект, ТекущиеДопПарметрыКоторыеПонадобятсяДалее);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ОткрытьСмену", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма, , СокрЛП(ТекущийПродавец))
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат; //
			конецЕсли;
			//ВстариваниеВКонфуУТ11 2024 --			


****************************************************

//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеПечатиZОтчетаРеальное(РезультатПечатиZОтчетаНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("ЗавершениеZОтчета с реузльатом" + СокрЛП(РезультатПечатиZОтчетаНаККТ));
	Если РезультатПечатиZОтчетаНаККТ = НЕОПРЕДЕЛЕНО тогда
		Сообщить("При снятии отчета на фискальном регистраторе произошла ошибка");
		Возврат;
	конецЕсли;
	Если Не РезультатПечатиZОтчетаНаККТ.Результат 
		И Не ДопПараметры.ИспользоватьБезПодключенияОборудования 
		Тогда		
		ТекстВопроса = НСтр("ru = 'При снятии отчета на фискальном регистраторе произошла ошибка.
		                    |""%ОписаниеОшибки%""
		                    |
		                    |Если смена на фискальном регистраторе закрыта, то
		                    |нажмите ""Да"" для формирования отчета о розничных продажах.
		                    |
		                    |Закрыть смену?'");
		ТекстВопроса = СтрЗаменить(ТекстВопроса, "%ОписаниеОшибки%", РезультатПечатиZОтчетаНаККТ.ОписаниеОшибки);
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("ИдентификаторУстройства", ДопПараметры.ИдентификаторУстройства);
		ДополнительныеПараметры.Вставить("ОписаниеОшибки", РезультатПечатиZОтчетаНаККТ.ОписаниеОшибки);
		ДополнительныеПараметры.Вставить("ИспользоватьБезПодключенияОборудования", ДопПараметры.ИспользоватьБезПодключенияОборудования);
		ПоказатьВопрос(
				Новый ОписаниеОповещения("ЗакрытьКассовуюСменуФрагмент", ЭтотОбъект, ДополнительныеПараметры),
				ТекстВопроса,
				РежимДиалогаВопрос.ДаНет,
				,
				КодВозвратаДиалога.Нет);
	Иначе			
		СформироватьОтчетОРозничныхПродажах();
	КонецЕсли;			
конецПроцедуры //ЗавершениеПечатиЧека
//ВстариваниеВКонфуУТ11 2024 --

&НаКлиенте
Процедура ЗакрытьКассовуюСмену(Команда)
	
	ОчиститьСообщения();
	
	Результат = Ложь;
	ОшибкаПриСнятииZОтчета = Ложь;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда
		
		// Подключение устройства
		ИдентификаторУстройства                = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ИдентификаторУстройства <> Неопределено Или ИспользоватьБезПодключенияОборудования Тогда
			
			ОписаниеОшибки = "";
			
			//Сообщить("Вставка кода для печти z-отчета");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее = Новый Структура;
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИдентификаторУстройства", ИдентификаторУстройства);
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИспользоватьБезПодключенияОборудования", ИспользоватьБезПодключенияОборудования);			
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеПечатиZОтчетаРеальное", ЭтотОбъект, ТекущиеДопПарметрыКоторыеПонадобятсяДалее);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ZОтчет", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма, , СокрЛП(ТекущийПродавец))
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат; //
			конецЕсли;	
			//ВстариваниеВКонфуУТ11 2024 --


****************************************************

//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеПечатиСлипаРеальное(РезультатПечатиЧекаНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("ЗавершениеПечатиЧека с реузльатом" + СокрЛП(РезультатПечатиЧекаНаККТ));
	ОписаниеОшибки = "";
	резЗакрытияФормыПредваритПросмЧека = ИСТИНА;
	Если РезультатПечатиЧекаНаККТ = НЕОПРЕДЕЛЕНО тогда
		ОписаниеОшибки = "Печать слипа отменена пользователем";
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
	иначеЕсли Не РезультатПечатиЧекаНаККТ.Результат тогда
		резЗакрытияФормыПредваритПросмЧека = ЛОЖЬ;
		ОписаниеОшибки = РезультатПечатиЧекаНаККТ.ОписаниеОшибки;
	конецЕсли;
	РезультатФР = РезультатПечатиЧекаНаККТ.Результат;
	
	ИдентификаторУстройстваЭТ = ДопПараметры.ИдентификаторУстройстваЭТ;
	СуммаОперации = ДопПараметры.СуммаОперации;	
	РезультатЭТ = ДопПараметры.РезультатЭТ;
	НомерСсылкиОперации = ДопПараметры.НомерСсылкиОперации;
	НомерЧекаЭТ = ДопПараметры.НомерЧекаЭТ;
	СтруктрураЭквайринговыйТерминал = ДопПараметры.СтруктрураЭквайринговыйТерминал;
	НомерКарты = ДопПараметры.НомерКарты;
	НомерЧекаЭТ = ДопПараметры.НомерЧекаЭТ;
	КодАвторизации = ДопПараметры.КодАвторизации;
	ТекстОписаниеОшибки = ДопПараметры.ТекстОписаниеОшибки;						
	ИспользоватьБезПодключенияОборудования = ДопПараметры.ИспользоватьБезПодключенияОборудования;
		
	Если РезультатЭТ И (Не РезультатФР И Не ИспользоватьБезПодключенияОборудования) Тогда		
		ОписаниеОшибкиФР = ОписаниеОшибки;		
		ВходныеПараметры  = Новый Массив();
		ВыходныеПараметры = Неопределено;
		
		ВходныеПараметры.Добавить(СуммаОперации);
		ВходныеПараметры.Добавить(НомерСсылкиОперации);
		ВходныеПараметры.Добавить(НомерЧекаЭТ);
		
		// Выполнение операции на ЭТ
		МенеджерОборудованияКлиент.ВыполнитьКоманду(
			ИдентификаторУстройстваЭТ,
			"EmergencyVoid",
			ВходныеПараметры,
			ВыходныеПараметры);
		
		ТекстСообщения = НСтр("ru = 'При печати слип-чека возникла ошибка:
		                            |""%ОписаниеОшибки%"".
		                            |Операция по карте была отменена.'");
		
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
		                             "%ОписаниеОшибки%",
		                             ОписаниеОшибкиФР);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
	ИначеЕсли РезультатЭТ Тогда
		
		// Сохранить в таблице данные оплаты картой
		СтрокаОплатыКартой = Объект.ОплатаПлатежнымиКартами.Добавить();
		
		СтрокаОплатыКартой.ЭквайринговыйТерминал = СтруктрураЭквайринговыйТерминал.Ссылка;
		СтрокаОплатыКартой.НомерПлатежнойКарты = НомерКарты; // Возможна запись пустого номера карты или номера вида "****************"
		СтрокаОплатыКартой.Сумма = СуммаОперации;
		СтрокаОплатыКартой.СсылочныйНомер = НомерСсылкиОперации;
		СтрокаОплатыКартой.НомерЧекаЭТ = НомерЧекаЭТ;
		СтрокаОплатыКартой.КодАвторизации = КодАвторизации;		
		Записать(); // Обязателено необходимо записать документ, для предотвращения потери информации.		
		ПересчитатьДокументНаКлиенте();		
		УстановитьАктивныйЭлемент();		
	КонецЕсли;		
конецПроцедуры //ЗавершениеПечатиСлипаРеальное

&НаКлиенте
Процедура ДобавитьОплатуКартойЗавершениеФрагмент(ДополнительныеПараметры)
	
	ИдентификаторУстройстваФР = ДополнительныеПараметры.ИдентификаторУстройстваФР;
	ИдентификаторУстройстваЭТ = ДополнительныеПараметры.ИдентификаторУстройстваЭТ;
	ИспользоватьБезПодключенияОборудования = ДополнительныеПараметры.ИспользоватьБезПодключенияОборудования;
	КодАвторизации = ДополнительныеПараметры.КодАвторизации;
	НомерКарты = ДополнительныеПараметры.НомерКарты;
	НомерСсылкиОперации = ДополнительныеПараметры.НомерСсылкиОперации;
	НомерЧекаЭТ = ДополнительныеПараметры.НомерЧекаЭТ;
	СтруктрураЭквайринговыйТерминал = ДополнительныеПараметры.СтруктрураЭквайринговыйТерминал;
	СуммаОперации = ДополнительныеПараметры.СуммаОперации;
	СтрокаСлипЧека = ДополнительныеПараметры.СтрокаСлипЧека;
	ТекстОписаниеОшибки = ДополнительныеПараметры.ТекстОписаниеОшибки;
	РезультатЭТ = ДополнительныеПараметры.РезультатЭТ;
	РезультатФР = ДополнительныеПараметры.РезультатФР;
	
	Если Не РезультатЭТ Тогда
		
		ТекстСообщения = НСтр("ru = 'При выполнении операции возникла ошибка:
		                            |""%ОписаниеОшибки%"".
		                            |Оплата по карте не была произведена.'");
		
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
			"%ОписаниеОшибки%",
			ТекстОписаниеОшибки);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
	Иначе
		
		Если Не ПустаяСтрока(СтрокаСлипЧека) И Не ИспользоватьБезПодключенияОборудования Тогда
			
			ВходныеПараметры = Новый Массив();
			ВходныеПараметры.Добавить(СтрокаСлипЧека);
			ВыходныеПараметры = Неопределено;
			
			//Сообщить("Вставка кода для печти");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеПечатиСлипаРеальное", ЭтотОбъект, ДополнительныеПараметры);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ПечатьСлипа", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма, , СокрЛП(ТекущийПродавец))
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат; //
			конецЕсли;
