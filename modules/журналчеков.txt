//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеОтркытиеСменыРеальное(РезультатОтркытиеСменыНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("РезультатОтркытиеСменыНаККТ с реузльатом" + СокрЛП(РезультатОтркытиеСменыНаККТ));
	Если РезультатОтркытиеСменыНаККТ = НЕОПРЕДЕЛЕНО тогда
		Сообщить("При открытии смены на фискальном регистраторе произошла ошибка");
		Возврат;
	конецЕсли;	
	Если Не РезультатОтркытиеСменыНаККТ.Результат 
		И Не ДопПараметры.ИспользоватьБезПодключенияОборудования Тогда		
		ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
		                      |Смена не открыта на фискальном регистраторе.
		                      |Дополнительное описание:
		                      |%ДополнительноеОписание%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения,
		                       "%ДополнительноеОписание%",
		                         РезультатОтркытиеСменыНаККТ.ОписаниеОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);		
	Иначе			
		Результат = ОткрытьКассовуюСменуНаСервереБезКонтекста(КассаККМ, ОписаниеОшибки);		
		Если Не Результат Тогда						
			ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
			                            |Смена не открыта.
			                            |Дополнительное описание:
			                            |%ДополнительноеОписание%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ДополнительноеОписание%", ОписаниеОшибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
						
		КонецЕсли;
	КонецЕсли;		
	
	ОбновитьСостояниеКассовойСменыИУстановитьОтборДинамическихСписковНаКлиенте(КассаККМ);
конецПроцедуры //ЗавершениеОтркытиеСменыРеальное

&НаКлиенте
Процедура ОткрытьКассовуюСмену(Команда)
	
	ОчиститьСообщения();
	
	Если НЕ ЗначениеЗаполнено(КассаККМ) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = Ложь;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда
		
		// Подключение устройства
		ИдентификаторУстройства                = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ИдентификаторУстройства <> Неопределено ИЛИ ИспользоватьБезПодключенияОборудования Тогда
			
			ОписаниеОшибки = "";
			
			//Сообщить("Вставка кода для открытия смены");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее = Новый Структура;
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИдентификаторУстройства", ИдентификаторУстройства);
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИспользоватьБезПодключенияОборудования", ИспользоватьБезПодключенияОборудования);
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеОтркытиеСменыРеальное", ЭтотОбъект, ТекущиеДопПарметрыКоторыеПонадобятсяДалее);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ОткрытьСмену", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма)
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат; //
			конецЕсли;
			//ВстариваниеВКонфуУТ11 2024 --			
			
			Результат = МенеджерОборудованияКлиентПереопределяемый.ОборудованиеПодключено(ИдентификаторУстройства);
			
			Если Результат ИЛИ ИспользоватьБезПодключенияОборудования Тогда
				
				Если Не ИспользоватьБезПодключенияОборудования Тогда
					
					ВходныеПараметры  = Неопределено;
					ВыходныеПараметры = Неопределено;
					
					//Открыть смену на фискальном регистраторе
					Результат = МенеджерОборудованияКлиент.ВыполнитьКоманду(ИдентификаторУстройства,
					                                                        "OpenDay",
					                                                        ВходныеПараметры,
					                                                        ВыходныеПараметры);
					
				КонецЕсли;
				
				Если Результат ИЛИ ИспользоватьБезПодключенияОборудования Тогда
					
					Результат = ОткрытьКассовуюСменуНаСервереБезКонтекста(КассаККМ, ОписаниеОшибки);
					
					Если Не Результат Тогда
						
						ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
						                            |Смена не открыта.
						                            |Дополнительное описание:
						                            |%ДополнительноеОписание%'");
						ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ДополнительноеОписание%", ОписаниеОшибки);
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
						
					КонецЕсли;
					
				Иначе
					ТекстСообщения = НСтр("ru = 'При открытии смены произошла ошибка.
					                      |Смена не открыта на фискальном регистраторе.
					                      |Дополнительное описание:
					                      |%ДополнительноеОписание%'");
					ТекстСообщения = СтрЗаменить(ТекстСообщения,
					                             "%ДополнительноеОписание%",
					                             ВыходныеПараметры[1]);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				КонецЕсли;
				
			Иначе
				
				ТекстСообщения = НСтр("ru = 'При подключении устройства произошла ошибка.
				                            |Смена не открыта на фискальном регистраторе.
				                            |Дополнительное описание:
				                            |%ДополнительноеОписание%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ДополнительноеОписание%", ОписаниеОшибки);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		ТекстСообщения = НСтр("ru = 'Предварительно необходимо выбрать рабочее место внешнего оборудования текущего сеанса.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
	КонецЕсли;
	
	ОбновитьСостояниеКассовойСменыИУстановитьОтборДинамическихСписковНаКлиенте(КассаККМ);
	
КонецПроцедуры //ОткрытьКассовуюСмену

//ВстариваниеВКонфуУТ11 2024
&НаКлиенте
процедура ЗавершениеПечатиZОтчетаРеальное(РезультатПечатиZОтчетаНаККТ, ДопПараметры) экспорт
	Перем ОписаниеОшибки;
	//ДопПараметры - пустые, не понятно какая информация может нам понадоится
	//Сообщить("ЗавершениеZОтчета с реузльатом" + СокрЛП(РезультатПечатиZОтчетаНаККТ));
	Если РезультатПечатиZОтчетаНаККТ = НЕОПРЕДЕЛЕНО тогда
		Сообщить("При снятии отчета на фискальном регистраторе произошла ошибка");
		Возврат;
	конецЕсли;
	Если Не РезультатПечатиZОтчетаНаККТ.Результат 
		И Не ДопПараметры.ИспользоватьБезПодключенияОборудования 
		Тогда		
		ТекстВопроса = НСтр("ru = 'При снятии отчета на фискальном регистраторе произошла ошибка.
		                    |""%ОписаниеОшибки%""
		                    |
		                    |Если смена на фискальном регистраторе закрыта, то
		                    |нажмите ""Да"" для формирования отчета о розничных продажах.
		                    |
		                    |Закрыть смену?'");
		ТекстВопроса = СтрЗаменить(ТекстВопроса, "%ОписаниеОшибки%", РезультатПечатиZОтчетаНаККТ.ОписаниеОшибки);
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("ИдентификаторУстройства", ДопПараметры.ИдентификаторУстройства);
		ДополнительныеПараметры.Вставить("ОписаниеОшибки", РезультатПечатиZОтчетаНаККТ.ОписаниеОшибки);
		ДополнительныеПараметры.Вставить("ИспользоватьБезПодключенияОборудования", ДопПараметры.ИспользоватьБезПодключенияОборудования);
		ПоказатьВопрос(
				Новый ОписаниеОповещения("ЗакрытьКассовуюСменуФрагмент", ЭтотОбъект, ДополнительныеПараметры),
				ТекстВопроса,
				РежимДиалогаВопрос.ДаНет,
				,
				КодВозвратаДиалога.Нет);
	Иначе			
		СформироватьОтчетОРозничныхПродажах();
	КонецЕсли;			
конецПроцедуры //ЗавершениеПечатиЧека

//ВстариваниеВКонфуУТ11 2024 --

&НаКлиенте
Процедура ЗакрытьКассовуюСмену(Команда)
	
	ОчиститьСообщения();
	
	Если НЕ ЗначениеЗаполнено(КассаККМ) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = Ложь;
	ОшибкаПриСнятииZОтчета = Ложь;
	
	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда
		
		// Подключение устройства
		ИдентификаторУстройства                = ПараметрыКассыККМ.ИдентификаторУстройства;
		ИспользоватьБезПодключенияОборудования = ПараметрыКассыККМ.ИспользоватьБезПодключенияОборудования;
		
		Если ИдентификаторУстройства <> Неопределено ИЛИ ИспользоватьБезПодключенияОборудования Тогда
			
			ОписаниеОшибки = "";
			
			//Сообщить("Вставка кода для печти z-отчета");
			//ВстариваниеВКонфуУТ11 2024
			//формаДокумента = ОткрытьФормуДокументаИзКоторогоБудетПечататьсяЧек();
			//скорее всего здесь надо вставить ссылку на процедуру обработки результата пеачти чека в модуле документа
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее = Новый Структура;
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИдентификаторУстройства", ИдентификаторУстройства);
			ТекущиеДопПарметрыКоторыеПонадобятсяДалее.Вставить("ИспользоватьБезПодключенияОборудования", ИспользоватьБезПодключенияОборудования);			
   			ОповещениеПриЗавершенииПечатиЧека = Новый ОписаниеОповещения("ЗавершениеПечатиZОтчетаРеальное", ЭтотОбъект, ТекущиеДопПарметрыКоторыеПонадобятсяДалее);
			Если ПодключаемоеОборудованиеУниверсальныйДрайверКлиент.ПечатьВызватьКомандуНаККТВместоВстроеннойВКонфигурацию(
					"ZОтчет", ОповещениеПриЗавершенииПечатиЧека, ЭтаФорма)
			тогда
				//Сообщить("Вставка кода для печти --");
				Возврат; //
			конецЕсли;
			//ВстариваниеВКонфуУТ11 2024 --
